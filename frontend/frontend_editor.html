<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>📅 Editable Smart Timetable</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    td[contenteditable="true"] { background-color: #f9f9f9; }
    #saveBtn { margin-top: 15px; }
  </style>
</head>
<body>
  <h2>🖊️ Editable Timetable (Live CSV View)</h2>

  <button id="saveBtn" onclick="saveAndRun()">💾 Save & Run Pipeline</button>
  <br /><br />
  <div id="tableContainer"></div>

  <h3>📋 Final Output:</h3>
  <pre id="resultBox"></pre>

  <script>
    let timetableData = [];
    let headers = [];

    // 📥 Load CSV from server on page load
    window.onload = () => {
      fetch("http://localhost:5000/load-final-csv")
        .then(res => res.text())
        .then(text => {
          const lines = text.split("\n").filter(l => l.trim());
          headers = lines[0].split(",");
          timetableData = lines.slice(1).map(row => row.split(","));
          renderTable();
        });
    };

    function renderTable() {
      const container = document.getElementById('tableContainer');
      let html = '<table><tr>';
      headers.forEach(h => html += `<th>${h}</th>`);
      html += '</tr>';

      timetableData.forEach((row, rowIndex) => {
        html += '<tr>';
        row.forEach((cell, colIndex) => {
          html += `<td contenteditable="true" oninput="updateCell(${rowIndex}, ${colIndex}, this.innerText)">${cell}</td>`;
        });
        html += '</tr>';
      });

      html += '</table>';
      container.innerHTML = html;
    }

    function updateCell(row, col, value) {
      timetableData[row][col] = value;
    }

    function saveAndRun() {
      const csvContent = [headers.join(',')]
        .concat(timetableData.map(row => row.join(',')))
        .join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const formData = new FormData();
      formData.append('file', blob, 'updated_from_ui.csv');

      fetch("http://localhost:5000/upload-timetable", {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          document.getElementById("resultBox").innerText = JSON.stringify(data, null, 2);
          alert("✅ Saved and Processed Successfully!");
        })
        .catch(err => {
          console.error(err);
          alert("❌ Error while processing");
        });
    }
  </script>
</body>
</html>
